#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include "prussdrv.h"
#include "pruss_intc_mapping.h"
#include "../common/mio.h"


/* host pru shared memory */

static void zero_words(size_t n)
{
  mio_handle_t mio;
  size_t i;

  if (mio_open(&mio, 0x80001000, 0x1000))
  {
    printf("unable to zero_words\n");
    return ;
  }

  for (i = 0; i != n; ++i)
    mio_write_uint32(&mio, i * sizeof(uint32_t), 0);

  mio_close(&mio);
}

static int read_words(uint32_t* x, size_t n)
{
  static const size_t sharedram_offset = 2048;
  volatile uint32_t* p;
  size_t i;

  prussdrv_map_prumem(PRUSS0_SHARED_DATARAM, (void**)&p);

  for (i = 0; i != 8; ++i) x[i] = p[sharedram_offset + i];

  return 0;
}

static void write_points()
{
  static const size_t sharedram_offset = 2048;
  //uint32_t points[] = {3991,38,3987,35,3991,4045,3987,4041,91,4045,87,4041,91,38,87,35,446,124,446,80,381,80,381,37,381,37,446,37,381,80,446,80,381,124,446,124,479,124,479,37,479,37,544,37,479,124,544,124,576,124,641,124,641,124,641,37,576,124,576,37,576,37,641,37,674,80,739,124,674,80,739,80,739,80,739,37,674,124,674,37,674,37,739,37,771,124,836,124,771,80,820,80,771,124,771,37,771,37,836,37,3599,37,3599,124,3599,124,3631,95,3631,95,3664,124,3664,124,3664,37,3696,124,3696,66,3696,66,3729,37,3729,37,3761,66,3761,66,3761,124,3696,87,3761,87,3794,37,3826,124,3826,124,3859,37,3891,124,3956,124,3891,80,3940,80,3891,124,3891,37,3891,37,3956,37,674,298,739,298,739,298,739,211,674,298,674,211,674,211,739,211,771,298,836,298,836,298,836,211,771,298,771,211,771,211,836,211,3404,124,3469,124,3420,51,3436,37,3436,37,3436,124,1811,385,1811,341,1746,341,1746,298,1746,298,1811,298,1746,341,1811,341,1746,385,1811,385,1844,385,1844,298,1844,341,1909,341,1909,385,1909,298,1941,385,2006,385,1941,298,2006,298,1974,298,1974,385,2039,385,2104,385,2039,341,2088,341,2039,385,2039,298,2039,298,2104,298,2136,298,2136,385,2136,385,2201,385,2234,385,2274,385,2274,385,2299,356,2299,356,2299,327,2299,327,2274,298,2274,298,2234,298,2234,298,2234,385,2039,37,2770,363,2770,363,2770,37,2770,37,2648,37,2648,91,2648,37,2648,37,2526,37,2526,91,2526,37,2526,37,2404,37,2404,200,2404,37,2404,37,2283,37,2283,91,2283,37,2283,37,2161,37,2161,91,2161,37,2161,37,2039,37,2039,37,1308,363,1308,363,1308,37,1308,37,1429,37,1429,91,1429,37,1429,37,1551,37,1551,91,1551,37,1551,37,1673,37,1673,200,1673,37,1673,37,1795,37,1795,91,1795,37,1795,37,1917,37,1917,91,1917,37,1917,37,2039,37,2055,211,2055,167,1990,167,1990,124,1990,124,2055,124,1990,167,2055,167,1990,211,2055,211,1303,2504,1344,2432,1344,2432,1344,2468,1344,2468,1385,2468,1385,2468,1303,2504,1303,2577,1344,2649,1344,2649,1344,2613,1344,2613,1385,2613,1385,2613,1303,2577,1222,2577,1182,2649,1182,2649,1182,2613,1182,2613,1141,2613,1141,2613,1222,2577,1222,2504,1182,2432,1182,2432,1182,2468,1182,2468,1141,2468,1141,2468,1222,2504,1680,4095,1754,4050,1754,4050,1836,3978,1836,3978,2079,3978,2079,3978,2161,4050,2161,4050,2235,4095,2129,4095,2079,4050,2079,4050,1836,4050,1836,4050,1786,4095,1792,4095,1795,4086,2120,4050,2135,4095,2275,4095,2242,4050,2242,4050,2120,3905,2120,3905,2039,3832,2039,3832,2079,3978,2039,3832,1876,3832,1876,3832,1836,3978,1876,3832,1795,3905,1795,3905,1673,4050,1673,4050,1640,4095,4095,2316,4030,2316,4030,2316,3948,2388,3948,2388,4095,2388,3948,2388,3948,2461,3948,2461,4095,2461,3948,2461,4030,2533,4030,2533,4095,2533,3989,2497,3908,2497,3908,2497,3867,2461,3867,2461,3948,2461,3867,2461,3867,2388,3867,2388,3948,2388,3867,2388,3908,2352,3908,2352,3989,2352,4070,2316,4030,2243,4030,2243,3908,2170,3908,2170,3664,2170,3664,2170,3664,2207,3664,2207,3745,2243,3745,2243,3786,2316,3786,2316,3786,2533,3786,2533,3745,2606,3745,2606,3664,2642,3664,2642,3664,2678,3664,2678,3908,2678,3908,2678,4030,2606,4030,2606,4070,2533,4030,2606,3786,2606,3786,2606,3664,2678,3786,2606,3826,2533,3826,2533,3826,2316,3826,2316,3786,2243,3786,2243,4030,2243,3786,2243,3664,2170,3786,2388,3583,2388,3583,2388,3542,2424,3542,2424,3583,2461,3583,2461,3786,2461,3786,2424,3542,2424,0,4014,7,4014,7,4014,48,4050,48,4050,48,4095,48,4050,0,4072,0,4017,7,4014,0,3801,7,3796,7,3796,251,3796,251,3796,251,3832,251,3832,170,3869,170,3869,129,3941,129,3941,129,4095,89,4095,89,3941,89,3941,129,3869,129,3869,251,3796,129,3869,0,3869,129,3978,292,3905,292,3905,373,3905,373,3905,373,3941,373,3941,332,3978,332,3978,129,4086,129,4050,373,3941,332,3905,129,4014,0,2497,7,2497,7,2497,48,2461,48,2461,0,2461,48,2461,48,2388,48,2388,0,2388,48,2388,7,2352,7,2352,0,2352,0,2175,7,2170,7,2170,251,2170,251,2170,251,2207,251,2207,170,2243,170,2243,129,2316,129,2316,129,2533,129,2533,170,2606,170,2606,251,2642,251,2642,251,2678,251,2678,7,2678,7,2678,0,2674,0,2606,129,2606,129,2606,251,2678,129,2606,89,2533,89,2533,89,2316,89,2316,129,2243,129,2243,0,2243,129,2243,251,2170,129,2388,332,2388,332,2388,373,2424,373,2424,332,2461,332,2461,129,2461,129,2424,373,2424,4095,4014,4030,4014,4030,4014,3948,4086,3948,4086,3948,4095,3948,4086,3965,4095,4095,4047,4030,4014,4030,4014,3908,4014,3908,4014,3867,4050,3867,4050,3867,4095,3867,4050,3948,4086,3989,4050,3908,4014,4070,4014,4070,3941,4070,3941,4030,3869,4030,3869,3908,3796,3908,3796,3664,3796,3664,3796,3664,3832,3664,3832,3745,3869,3745,3869,3786,3941,3786,3941,3786,4095,3826,4095,3826,3941,3826,3941,3786,3869,3786,3869,3664,3796,3786,3869,4030,3869,3786,3978,3623,3905,3623,3905,3542,3905,3542,3905,3542,3941,3542,3941,3583,3978,3583,3978,3786,4086,3786,4050,3542,3941,3583,3905,3786,4014,2098,1729,2094,1726,2142,2375,2138,2372,2809,2285,2805,2281,2260,2321,2256,2317,2276,1588,2272,1584,3239,2129,3235,2125,1720,1784,1716,1780,1261,2020,1257,2016,1793,1824,1789,1820,1801,1740,1797,1737,1939,2404,1935,2401,1866,1896,1862,1893,2451,3827,2447,3823,875,3558,871,3555,3422,3932,3418,3929,2406,1388,2402,1385,1639,1279,1635,1276,1110,1200,1106,1196,2455,2564,2451,2561,2719,2695,2715,2691,2126,3036,2122,3032,2203,3079,2199,3076,2077,2793,2073,2789,2045,3163,2041,3159,2045,2956,2041,2952,2216,2807,2212,2804,2415,2800,2411,2796,2077,2963,2073,2960,2187,3283,2183,3279,2321,2568,2317,2564,2927,2619,2923,2615,2191,2444,2187,2441,2268,2582,2264,2579,2102,2517,2098,2513,964,2462,960,2459,3215,3272,3211,3268,3300,2466,3296,2463,1976,3050,1972,3047,1830,2916,1826,2913,1533,3232,1529,3228,1838,3254,1834,3250,1870,2760,1866,2756,1858,2825,1854,2822,1899,2586,1895,2582,1631,3061,1627,3058,2033,2967,2029,2963,1789,2597,1785,2593,1318,2844,1314,2840,1951,2764,1947,2760,2165,2530,2177,2533,2177,2533,2002,2533,2002,2533,1824,2533,1824,2533,1836,2533,1836,2533,2002,2530,2002,2530,2165,2530,2165,2530,2019,2533,2021,2535,2017,2531,2019,2533,2002,2533,2002,2533,1982,2533,1984,2535,1980,2531,1982,2533,2002,2533,2002,2533,2019,2533,2019,2533,2019,2450,2019,2450,2019,2446,2019,2446,2002,2446,2002,2446,1982,2450,1984,2452,1980,2448,1982,2450,2019,2450,2019,2450,2055,2417,2055,2417,2059,2414,2059,2414,2031,2410,2031,2410,2027,2377,2031,2410,1998,2428,1998,2428,1970,2410,1970,2410,1970,2377,1970,2410,1941,2414,1941,2414,1945,2417,1945,2417,2002,2417,2002,2417,2055,2417,2055,2417,2055,2381,2055,2381,2059,2377,2059,2377,2027,2377,2027,2377,1998,2359,1998,2359,1970,2377,1970,2377,1941,2381,1941,2381,1945,2384,1945,2384,2002,2384,2002,2384,2055,2381,2055,2381,2019,2348,2019,2348,2019,2345,2019,2345,1998,2345,1998,2345,1982,2348,1984,2350,1980,2346,1982,2348,1998,2348,1998,2348,2019,2348,2019,2348,2019,2265,2021,2266,2017,2263,2019,2265,1998,2261,1998,2261,1982,2265,1984,2266,1980,2263,1982,2265,1998,2265,1998,2265,2019,2265,2019,2265,2161,2272,2161,2272,2173,2254,2173,2254,1998,2247,1998,2247,1824,2254,1824,2254,1836,2276,1836,2276,1998,2279,1998,2279,2161,2272,2173,2254,2019,2265,2019,2265,2019,2345,2019,2345,2059,2377,2059,2377,2059,2414,2059,2414,2019,2446,2019,2446,2019,2533,2019,2533,2177,2533,2004,2535,2000,2531,2002,2533,2002,2446,2002,2446,1998,2428,1998,2359,1998,2345,1998,2345,1998,2261,1998,2261,1998,2247,1824,2254,1982,2265,1982,2265,1982,2348,1982,2348,1941,2381,1941,2381,1941,2414,1941,2414,1982,2450,1982,2450,1982,2533,1982,2533,1824,2533,1836,2533,1982,2533,1982,2533,1982,2450,1982,2450,1945,2417,1945,2417,1945,2384,1945,2384,1982,2348,1982,2348,1982,2265,1982,2265,1836,2276,1998,2279,1998,2265,1998,2265,1998,2348,1998,2348,2002,2384,2002,2384,2002,2417,2002,2417,1998,2450,1998,2450,2002,2533,2002,2533,2002,2530,1450,2620,1474,2613,1474,2613,1511,2562,1511,2562,1527,2519,1527,2519,1503,2526,1503,2526,1470,2573,1470,2573,1450,2620,1450,2620,1486,2573,1488,2575,1484,2571,1486,2573,1490,2566,1490,2566,1494,2562,1494,2562,1490,2562,1490,2562,1486,2570,1486,2570,1486,2573,1486,2573,1511,2588,1511,2588,1515,2588,1515,2588,1519,2584,1519,2584,1523,2577,1523,2577,1519,2577,1519,2577,1511,2588,1511,2588,1515,2606,1515,2606,1523,2602,1523,2602,1535,2595,1535,2595,1543,2599,1535,2595,1531,2584,1531,2584,1543,2577,1543,2577,1551,2584,1543,2577,1539,2573,1539,2573,1531,2573,1531,2573,1519,2591,1519,2591,1515,2606,1515,2606,1527,2613,1527,2613,1535,2609,1535,2609,1543,2599,1543,2599,1555,2595,1555,2595,1551,2584,1551,2584,1551,2577,1551,2577,1543,2580,1543,2580,1531,2599,1531,2599,1527,2613,1527,2613,1547,2606,1549,2608,1545,2604,1547,2606,1551,2599,1551,2599,1555,2595,1555,2595,1551,2595,1551,2595,1547,2602,1547,2602,1547,2606,1547,2606,1572,2620,1572,2620,1576,2620,1576,2620,1580,2613,1580,2613,1580,2609,1582,2611,1578,2608,1580,2609,1576,2617,1576,2617,1572,2620,1572,2620,1539,2664,1539,2664,1563,2660,1563,2660,1600,2609,1600,2609,1616,2566,1616,2566,1588,2573,1588,2573,1555,2620,1555,2620,1539,2664,1563,2660,1576,2620,1576,2620,1547,2606,1547,2606,1535,2609,1535,2609,1523,2602,1523,2602,1515,2588,1515,2588,1486,2573,1486,2573,1474,2613,1511,2562,1490,2566,1490,2566,1519,2584,1519,2584,1531,2584,1555,2595,1551,2599,1551,2599,1580,2613,1580,2613,1600,2609,1616,2566,1580,2609,1580,2609,1555,2595,1555,2595,1551,2577,1551,2577,1539,2573,1539,2573,1523,2577,1523,2577,1494,2562,1494,2562,1527,2519,1503,2526,1490,2562,1490,2562,1519,2577,1519,2577,1531,2573,1531,2573,1543,2580,1543,2580,1551,2595,1551,2595,1580,2609,1580,2609,1588,2573,1555,2620,1576,2617,1576,2617,1547,2602,1547,2602,1531,2599,1531,2599,1519,2591,1519,2591,1515,2584,1515,2584,1486,2570,1486,2570,1470,2573,2555,2490,2530,2493,2530,2493,2478,2461,2478,2461,2445,2424,2445,2424,2474,2421,2474,2421,2522,2453,2522,2453,2555,2490,2555,2490,2506,2461,2506,2461,2502,2461,2502,2461,2498,2457,2498,2457,2494,2453,2494,2453,2498,2453,2498,2453,2502,2457,2502,2457,2506,2461,2506,2461,2526,2439,2526,2439,2522,2439,2522,2439,2518,2435,2518,2435,2514,2432,2514,2432,2518,2432,2518,2432,2526,2439,2526,2439,2547,2435,2547,2435,2539,2439,2539,2439,2526,2432,2526,2432,2534,2424,2526,2432,2514,2432,2514,2432,2510,2421,2510,2421,2518,2414,2510,2421,2510,2414,2510,2414,2518,2414,2518,2414,2539,2424,2539,2424,2547,2435,2547,2435,2555,2428,2555,2428,2547,2428,2547,2428,2534,2424,2534,2424,2530,2414,2530,2414,2518,2414,2518,2414,2518,2406,2518,2406,2526,2406,2526,2406,2547,2417,2547,2417,2555,2428,2555,2428,2551,2410,2551,2410,2547,2414,2547,2414,2539,2410,2539,2410,2539,2403,2541,2404,2537,2401,2539,2403,2547,2406,2547,2406,2551,2410,2551,2410,2571,2388,2571,2388,2567,2388,2567,2388,2559,2384,2559,2384,2555,2381,2555,2381,2559,2381,2559,2381,2567,2384,2567,2384,2571,2388,2571,2388,2620,2421,2620,2421,2595,2421,2595,2421,2543,2388,2543,2388,2506,2352,2506,2352,2534,2352,2534,2352,2583,2384,2583,2384,2620,2421,2595,2421,2567,2388,2567,2388,2547,2414,2547,2414,2547,2428,2547,2428,2539,2439,2539,2439,2522,2439,2522,2439,2502,2461,2502,2461,2530,2493,2478,2461,2498,2457,2498,2457,2518,2435,2518,2435,2514,2432,2530,2414,2539,2410,2539,2410,2559,2384,2559,2384,2543,2388,2506,2352,2555,2381,2555,2381,2539,2403,2539,2403,2518,2406,2518,2406,2510,2414,2510,2414,2514,2432,2514,2432,2494,2453,2494,2453,2445,2424,2474,2421,2498,2453,2498,2453,2518,2432,2518,2432,2518,2414,2518,2414,2526,2406,2526,2406,2539,2403,2539,2403,2559,2381,2559,2381,2534,2352,2583,2384,2567,2384,2567,2384,2547,2406,2547,2406,2547,2417,2547,2417,2539,2424,2539,2424,2522,2435,2522,2435,2502,2457,2502,2457,2522,2453,2493,2164,2453,2164,2453,2006,2493,2164,2493,2164,2532,2058,2572,2164,2493,2164,2493,2164,2532,2270,2414,2270,2493,2164,2433,2800,2394,2800,2394,2641,2433,2800,2433,2800,2473,2694,2512,2800,2433,2800,2433,2800,2473,2906,2354,2906,2433,2800,1722,2997,1683,2997,1683,2838,1722,2997,1722,2997,1762,2891,1801,2997,1722,2997,1722,2997,1762,3103,1643,3103,1722,2997,1544,2164,1505,2164,1505,2006,1544,2164,1544,2164,1584,2058,1623,2164,1544,2164,1544,2164,1584,2270,1465,2270,1544,2164,2019,1729,1979,1729,1979,1570,2019,1729,2019,1729,2058,1623,2098,1729,2019,1729,2019,1729,2058,1834,1940,1834,2019,1729};
  uint32_t points[] = { 0x000,0x000,
                        0x7FF,0x7FF,
                        0xFFF,0x000,
                        0xFFF,0xFFF,
                        0x000,0xFFF};
  unsigned int i = 0;
  volatile uint32_t* p;

  prussdrv_map_prumem(PRUSS0_SHARED_DATARAM, (void**)&p);

  //p[sharedram_offset + offset] = 0xbeefdead;
  //p[sharedram_offset + offset + 1] = 0xbeefdead;
  //for (i = 0; i < 2484; i++)
  for(i=0; i<10; i++) 
  {
    p[sharedram_offset + i] = points[i];
  }
}


/* sigint handler */

static volatile unsigned int is_sigint = 0;

static void on_sigint(int x)
{
  is_sigint = 1;
}


/* main */

int main(int ac, char** av)
{
  tpruss_intc_initdata pruss_intc_initdata = PRUSS_INTC_INITDATA;
  uint32_t x[8];
  const size_t n = sizeof(x) / sizeof(x[0]);
  size_t i;

  prussdrv_init();

  if (prussdrv_open(PRU_EVTOUT_0))
  {
    printf("prussdrv_open open failed\n");
    return -1;
  }

  prussdrv_pruintc_init(&pruss_intc_initdata);

  /* zero_words(n); */

#define PRU_NUM 0

  /* write data from data.bin */
  prussdrv_load_datafile(PRU_NUM, "./data.bin");

  /* execute code on pru0 */
  prussdrv_exec_program_at(PRU_NUM, "./text.bin", START_ADDR);

  signal(SIGINT, on_sigint);

  //write_points();
  write_points();
  while (is_sigint == 0)
  {
    usleep(1000000);
    read_words(x, n);
    for (i = 0; i != n; ++i)
    {
      printf("0x%08x (%f)\n", x[i], *((float*)(x + i)));
    }
    printf("\n");
  }

  /* disable pru and close memory mapping */
  prussdrv_pru_disable(PRU_NUM);
  prussdrv_exit();

  return 0;
}
